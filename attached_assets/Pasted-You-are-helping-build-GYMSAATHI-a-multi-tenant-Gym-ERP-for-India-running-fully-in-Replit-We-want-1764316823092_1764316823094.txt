You are helping build GYMSAATHI, a multi-tenant Gym ERP for India, running fully in Replit.

We want to add a premium QR-based attendance feature that connects Admin and Member dashboards.

0. Tech Context

Environment: Replit

Frontend: React 18 + TypeScript + Vite

Backend: Node.js + Express + TypeScript

Auth: Session-based express-session, roles: superadmin, admin, trainer, member

DB: Replit Database (keyâ€“value)

UI: TailwindCSS + Radix UI

Existing pages:

Admin: /admin/attendance (Currently in Gym, Check-ins Today, Unique Members, Todayâ€™s check-ins list, manual check-in dropdown)

Member: /member dashboard already exists

We want to extend this, not break current functionality.

ğŸ¯ Feature Overview â€“ QR Attendance

Goal:
Each gym gets a unique attendance QR code which they print and paste at the reception.
Members open their Member Dashboard on mobile â†’ tap â€œScan to Check-inâ€ â†’ scan the QR code â†’ attendance is automatically recorded for that gym and that member (if eligible).

Requirements:

Multi-tenant: each gymâ€™s QR is unique & scoped by gymId.

Member must:

Be logged in as role = member

Belong to that gym (member.gymId === qr.gymId)

Have an active membership/eligible plan.

Attendance should update Admin Attendance dashboard in real time (or on refresh):

Currently in Gym

Check-ins Today

Unique Members

Todayâ€™s Check-ins list

ğŸ” QR Design & Security
1. Gym QR Config Model

Store a per-gym configuration in Replit DB:

Key: attendanceQrConfig:{gymId} â†’

interface AttendanceQrConfig {
  gymId: string;
  secret: string;         // random string, used for verification
  isEnabled: boolean;
  lastRotatedAt: string;  // ISO date
}


secret is generated once (or when admin hits â€œRegenerate QRâ€).

We donâ€™t want members to fake QR codes, so every QR encodes this secret.

2. QR Payload

The data encoded in the QR should be a compact JSON or string, e.g.:

{
  "type": "gym_attendance",
  "gymId": "gym_123",
  "secret": "abc123xyz"
}


or a pipe-delimited string:
GYMSAATHI|ATTENDANCE|{gymId}|{secret}

The member app DOES NOT call this URL directly; it reads the QR data and then posts it to the backend.

ğŸ—„ Attendance Data Model (Replit DB)

We already have attendance per member. Expand / standardize:

Key: attendance:{gymId}:{attendanceId}

type AttendanceStatus = "in" | "out";

interface AttendanceRecord {
  id: string;          // uuid
  gymId: string;
  memberId: string;
  memberName: string;
  checkInTime: string;   // ISO
  checkOutTime?: string; // ISO
  status: AttendanceStatus; // "in" if currently in gym
  source: "admin_manual" | "qr_scan" | "class"; // new source
}


Index keys:

attendanceIndex:{gymId}:{YYYY-MM-DD} â†’ array of attendanceId for that day.

ğŸ§© Eligibility Rules

When a QR scan happens:

Decode QR payload â†’ get gymId and secret.

Find AttendanceQrConfig by gymId.

Validate:

config.isEnabled === true

config.secret matches QR secret

From session, get current member:

role must be member

member.gymId === gymId from QR

Check membership eligibility:

member.membershipStatus === "active"

membership not expired

membership plan has qrAttendanceEnabled === true (add this field to plan/membership model).

Prevent duplicate check-in:

For this memberId and today, if there is an AttendanceRecord with status="in", then either:

treat scan as check-out (toggle out), or

block and return message â€œAlready checked inâ€.

For this feature, implement:

First scan of the day: create record, status "in"

Second scan while status "in": set checkOutTime and status "out".

ğŸ›  Backend API Endpoints
Admin-side (gym owner/manager)

Prefix: /api/admin/attendance/qr

GET /api/admin/attendance/qr/config

Returns current gymâ€™s QR config (without secret) and a QR image URL or QR data string for frontend to render.

Use session adminâ€™s gymId.

Response:

interface AdminQrConfigResponse {
  gymId: string;
  isEnabled: boolean;
  qrData: string;  // the data to encode in QR (gymId + secret)
}


POST /api/admin/attendance/qr/generate

(Re)generates new secret for that gym, sets isEnabled = true.

Returns new qrData.

POST /api/admin/attendance/qr/toggle

Body: { isEnabled: boolean }

Enables/disables QR attendance for that gym.

These endpoints require auth: role = admin.

Member-side (QR scan)

Prefix: /api/member/attendance

POST /api/member/attendance/scan

Body:

interface AttendanceScanRequest {
  qrData: string; // raw string / JSON read from QR
}


Behavior:

Decode & validate QR payload.

Verify config secret matches, isEnabled = true.

Get member from session.

Check gymId match, membership active & eligible plan.

Look up todayâ€™s attendance for this member:

If none â†’ create new AttendanceRecord (check-in).

If exists with status "in" â†’ set checkOutTime + status "out"`.

Return:

interface AttendanceScanResponse {
  status: "checked_in" | "checked_out" | "error";
  message: string;
  record?: AttendanceRecord;
}


Update attendanceIndex:{gymId}:{date}.

Authorization: must be logged in as member.

ğŸ› Admin UI â€“ QR Management (Attendance Page)

Extend existing /admin/attendance page:

At the top (above "Member Check-In") add new card:

â€œQR Attendanceâ€ Card

Shows:

Toggle: QR Attendance: Enabled / Disabled.

Explanation text: Print this QR code and place it at your gym entrance. Members can scan it from their app to check in and out automatically.

QR image rendered using a React QR library (e.g. qrcode.react).

Buttons:

Download QR (download as PNG for printing).

Regenerate QR (warning: this will invalidate old printouts).

When toggled off: QR becomes greyed out; member scanning should fail with message from backend (â€œQR attendance disabled for this gymâ€).

Adminâ€™s existing KPIs (Currently in Gym, Check-ins Today, Unique Members) must now reflect QR-based attendance too (source=qr_scan).

ğŸ“± Member UI â€“ â€œScan to Check-inâ€

On the Member Dashboard (and/or a dedicated Attendance tab):

1. Add a primary button:

Scan QR to Check-in

When tapped:

Open a full-screen QR Scanner screen (mobile-first):

Use camera via navigator.mediaDevices.getUserMedia.

Or integrate a library like react-qr-reader or html5-qrcode.

Show:

Title: Scan Gym QR Code

Hint text: Point your camera at the QR code at the gym reception to mark your attendance.

Once a QR code is detected:

Get qrData string.

POST to /api/member/attendance/scan.

Show result:

On success "checked_in":

Big success state: You're checked in!

Show time.

On success "checked_out":

You're checked out. See you again!

On error:

Show error message: e.g. Your membership is inactive / Invalid QR code / QR attendance disabled.

After success, navigate back to member dashboard and refresh their Attendance summary.

2. Member Personal Attendance Summary

On the member dashboard or a Attendance tab:

Show:

Todayâ€™s status: In Gym / Checked Out / Not Checked In.

Last check-in / check-out times.

Attendance history (last 7 / 30 days).

All using existing attendance records where memberId = current user.

ğŸ“Š Admin Attendance Dashboard Updates

Ensure /admin/attendance uses attendance data from both:

Manual check-ins (existing)

QR-based attendance (source="qr_scan")

KPIs to show:

Currently in Gym â†’ count of records with status="in" and today.

Check-ins Today â†’ count of all records created today.

Unique Members â†’ distinct members checked-in today.

Todayâ€™s Check-ins table â†’ show:

Member

Check-in time

Check-out time (if present)

Status (In Gym / Checked Out)

Source icon (QR vs manual)

ğŸ§ª Edge Cases & Validation

Wrong gym QR

If member scans a QR from a different gym (gymId mismatch), backend returns error:
"This QR code belongs to another gym".

Inactive membership / plan not eligible

Response: { status: "error", message: "Your membership or plan does not allow QR attendance. Please contact the gym." }.

Multiple check-ins

If member has already "in" record and tries to check-in again, treat as check-out or show message depending on rule (weâ€™ve chosen toggle in/out).

QR Disabled by Admin

Return "QR attendance is currently disabled for this gym.".

Unauthenticated scan

If member is not logged in / session expired:

Redirect to login, maybe keep scanned qrData in query string and retry after login (optional; at minimum, return 401 with message).

ğŸ”§ Implementation Notes

Keep all new types in a shared schema.ts or similar.

Add new fields to membership/plan model: qrAttendanceEnabled: boolean.

For QR rendering on Admin side, use qrcode.react or another simple library.

For Member scanning, ensure permission prompts and errors are handled (camera denied, etc.).

Make layouts fully responsive (especially member QR scan view for mobile).

ğŸ¯ Final Goal

After implementing this spec:

Every Gym Admin can:

Generate/disable/regenerate a gym-specific QR attendance code.

Print it and place at reception.

See QR-based check-ins live in the Attendance page.

Every Member can:

Open Gymsaathi member app on mobile.

Tap â€œScan QR to Check-inâ€.

Automatically mark check-in / check-out for their gym.

View their own attendance history.

All of this must be built with Node.js + Express + TypeScript + React + Vite + Tailwind + Replit DB, production-ready, following the above structure and validation rules.
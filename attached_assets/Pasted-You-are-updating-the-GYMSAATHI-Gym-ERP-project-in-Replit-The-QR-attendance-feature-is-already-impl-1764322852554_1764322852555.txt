You are updating the GYMSAATHI Gym ERP project in Replit.

The QR attendance feature is already implemented with:

QR generation & management for each gym

Member QR scanner

Attendance records with:

status enum: 'in' | 'out'

exit_type enum: 'manual' | 'auto'

source field: 'qr_scan' | 'admin_manual' | 'class'

A strict state machine and DB constraint:

Unique partial index so each (gym_id, member_id) has at most one open session where status='in' AND check_out_time IS NULL.

Now we want to refine the UX and permissions and make screens auto-update.

ðŸŽ¯ New Business Rules (must follow exactly)

Check-in = QR scan only

Member must scan the gymâ€™s QR code to check in.

Check-in creates a new attendance record with:

status = 'in'

exit_type = NULL

source = 'qr_scan'.

Check-out = button only (no QR)

Member should NOT scan QR to check out.

When they want to leave, they simply tap a â€œCheck Outâ€ button in the Member Dashboard.

That calls a separate backend endpoint which closes the open attendance record.

Admin cannot check out members

Admin must not have any button or action to set checkOutTime or change status to 'out'.

Admin can view all attendance data in real time, but cannot perform checkout.

(Optional: admin can still do manual check-in for edge cases, but checkout remains member-only + auto.)

Auto-checkout after 3 hours

Auto-close rule stays:

If a member stays â€œinâ€ for > 3 hours, system sets:

check_out_time = check_in_time + 3 hours

status = 'out'

exit_type = 'auto'

After auto-close, member is considered not in gym and next check-in requires scanning QR again.

Real-time feel / auto-refresh

When member checks in or out:

Admin Attendance page should update without a manual refresh.

Member Dashboard + Attendance snippets should also auto-update.

Use React Query features:

invalidateQueries after actions.

refetchInterval for key dashboard queries (5â€“10 seconds).

refetchOnWindowFocus: true.

We DO NOT need WebSockets; a combination of React Query + short polling is good enough.

1ï¸âƒ£ Backend Changes
1.1 Split check-in vs check-out endpoints

Currently, QR scan endpoint does â€œtoggleâ€ (in/out). Change this to check-in only and add a separate checkout endpoint.

a) Check-in by QR

Update existing QR scan endpoint, e.g.:

POST /api/member/attendance/scan

Behavior:

Decode & validate QR (gymId, secret, enabled, member eligibility) â€“ keep existing logic.

Find open session with helper (including auto-close if >3 hours).

If there is still an open session after auto-close logic:

Do NOT check them out here.

Return an error with a clear code, e.g.:

{
  "status": "error",
  "code": "ALREADY_IN_GYM",
  "message": "You are already checked in. Use the Check Out button to leave."
}


If no open session:

Create new record:

status = 'in'

exit_type = null

source = 'qr_scan'

Return:

{
  "status": "checked_in",
  "message": "You are checked in!",
  "record": { ... }
}

b) New endpoint: checkout via button

Add a new endpoint, e.g.:

POST /api/member/attendance/checkout

Behavior:

Read member from session (must be role = 'member').

Using existing helpers, find the open session for this (gymId, memberId):

This helper must also auto-close sessions older than 3 hours and then return null if none.

If no open session:

Return error:

{
  "status": "error",
  "code": "NOT_IN_GYM",
  "message": "You are not currently checked in."
}


If open session exists AND itâ€™s within 3 hours:

Close it:

check_out_time = now

status = 'out'

exit_type = 'manual'

Save and return:

{
  "status": "checked_out",
  "message": "You are checked out. See you again!",
  "record": { ... }
}


Use the same getOpenAttendanceSession and closeCheckInManually style helpers in server/storage.ts. Keep using the unique index for invariants.

1.2 Remove admin ability to checkout

In the backend:

Make sure there is no admin route that:

Directly modifies check_out_time of records, or

Changes status to 'out' for QR-based sessions.

If such admin mutation exists, restrict it to special cases (or remove it), and certainly do not expose it in the Admin UI anymore.

Admin routes should be read-only for QR-sourced attendance.

1.3 Member â€œtoday statusâ€ endpoint (for UI)

Ensure there is an endpoint like:

GET /api/member/attendance/today

Return:

interface MemberAttendanceToday {
  inGym: boolean;
  lastRecord?: AttendanceRecord; // today
}


Use getOpenAttendanceSession + todayâ€™s attendance to derive inGym.

2ï¸âƒ£ Frontend Changes â€“ Member
2.1 Member Dashboard: separate buttons

File: client/src/pages/MemberDashboard.tsx

Use React Query to call /api/member/attendance/today.

State:

If inGym === false:

Show status badge: â€œNot Checked Inâ€

Show main action button:

Label: â€œScan QR to Check Inâ€

On click â†’ open QrScanner component.

If inGym === true:

Show status badge: â€œIn Gymâ€

Show main action button:

Label: â€œCheck Outâ€

On click â†’ call POST /api/member/attendance/checkout.

2.2 QrScanner.tsx â€“ check-in only

File: client/src/components/QrScanner.tsx

Adjust logic so:

On QR decode:

Call only the check-in endpoint /api/member/attendance/scan.

Handle responses:

If status === "checked_in":

Show success toast.

Close scanner.

invalidateQueries for:

memberAttendanceToday

adminAttendanceDashboard (if query keys are shared/global or via a refetch mechanism).

If code === "ALREADY_IN_GYM":

Show info toast: â€œYouâ€™re already checked in, use the Check Out button.â€

Close scanner.

Any other error â†’ show error toast and keep/expose option to retry.

2.3 Member Check Out button

On click:

Call POST /api/member/attendance/checkout.

On status === "checked_out":

Show success toast.

Invalidate/re-fetch:

memberAttendanceToday

any attendance history query

admin attendance dataset (see next section).

On code === "NOT_IN_GYM":

Show info toast: â€œYouâ€™re not currently checked in.â€

3ï¸âƒ£ Frontend Changes â€“ Admin (Attendance page)

File: client/src/pages/Attendance.tsx and client/src/components/GymCheckIn.tsx

3.1 Remove admin checkout controls

If there are any Action buttons per row to check out / close the session:

Remove them or disable for QR sessions.

Admin attendance table becomes read-only:

Columns: Member, Check-in Time, Check-out Time, Status badge, Source icon.

Status logic:

status === 'in' â†’ badge: â€œIn Gymâ€

status === 'out' && exit_type === 'manual' â†’ â€œChecked Outâ€

status === 'out' && exit_type === 'auto' â†’ â€œAuto Checked-outâ€

3.2 Auto-refresh Admin view

Attendance page should feel â€œliveâ€:

For the main query that fetches â€œTodayâ€™s attendance + KPIs (Currently in Gym, Check-ins Today, Unique Members)â€:

Use React Query options:

useQuery(['adminAttendance', gymId], fetchFn, {
  refetchInterval: 5000, // every 5s or 10s
  refetchOnWindowFocus: true,
});


Ensure any mutation from member side that changes attendance calls queryClient.invalidateQueries(['adminAttendance']) (or an equivalent key) so the admin page jumps to fresh data quickly.

For cross-role invalidation, you can do it globally where the mutation lives, or rely on polling + refetchOnWindowFocus.

4ï¸âƒ£ Global Auto-update Principles

For this change, focus primarily on Attendance-related auto updates, but keep the pattern reusable:

For key dashboards (Admin dashboard, Member dashboard, Attendance pages):

Use React Query with:

refetchInterval (5â€“15 seconds for stats that change often)

refetchOnWindowFocus: true

Manual invalidateQueries after important actions (check-in/out, payments, etc.).

Do not introduce WebSockets unless absolutely necessary; polling is enough for this release.

5ï¸âƒ£ Tests to Validate

After implementing:

Check-in via QR

Member is not in gym â†’ scan QR â†’ gets checked_in.

Member dashboard shows In Gym.

Admin Attendance page KPIs + table update automatically within a few seconds.

Check-out via button (no QR)

Member clicks Check Out â†’ gets checked_out.

Member dashboard shows Not Checked In.

Admin Attendance updates automatically (Currently in Gym decreases).

Wrong flow protections

Member tries to scan QR while already in gym:

Backend returns ALREADY_IN_GYM.

UI shows info message; no new record is created.

Member taps Check Out when not in gym:

Backend returns NOT_IN_GYM.

UI shows friendly message.

Auto checkout after 3 hours

Simulate by editing check_in_time in DB to > 3 hours ago.

Trigger any call (/attendance/today or /scan).

Record auto-closes (exit_type = 'auto'), status becomes 'out'.

New scan then behaves like a fresh check-in.

Admin must never be able to check out a member from UI.

Please implement all of the above by modifying existing code, not rewriting from scratch:

server/routes.ts (scan vs checkout endpoints)

server/storage.ts (helpers and state machine, but keep unique index)

client/src/pages/MemberDashboard.tsx

client/src/components/QrScanner.tsx

client/src/pages/Attendance.tsx

client/src/components/GymCheckIn.tsx

Keep the design consistent with current UI and Gymsaathi branding.